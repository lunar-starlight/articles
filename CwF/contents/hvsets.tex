\section{Heyting-valued Sets}

\def\h{\mathcal{H}}

\subsection{Preliminaries}

\begin{definition}
  A \emph{Heyting-valued set \(A\)} is a carrier set \(\carr A\) equipped with a
  ``Heyting-valued relation'' \(\eq[A]{-}{-} : AÃ—A â†’ \h\) satisfying
  \begin{gather}
    \label{hvs:symm}  \eq x y â‰¤ \eq y x\\
    \label{hvs:trans} \eq x y âˆ§ \eq y z â‰¤ \eq x z
  \end{gather}

  Define \(\e x â‰” \eq x x\).
\end{definition}

\begin{definition}
  A \emph{Heyting-valued morphism \(f : A â†¬ B\)} is a ``Heyting-valued,b
  functional relation'', meaning it is a map \(\carr f : \carr A Ã— \carr B â†’ \h\)
  satisfying
  \begin{gather}
    \label{hvm:str}    f(x,y) â‰¤ \e x âˆ§ \e y\\
    \label{hvm:well}   \eq {x'} x âˆ§ f(x, y) âˆ§ \eq y {y'} â‰¤ f(x', y')\\
    \label{hvm:unique} f(x, y) âˆ§ f(x, y') â‰¤ \eq y {y'}\\
    \label{hvm:total}  \e x â‰¤ â‹_{y âˆˆ B}f(x, y)
  \end{gather}
\end{definition}

\begin{fact}
  The following hold.

  \begin{enumerate}
  \item \(f(x,y)âˆ§\eq x {x'} = f(x',y)âˆ§\eq x {x'}\)
  \item \(\e x = â‹_{yâˆˆA}\eq x y\)
  \end{enumerate}
\end{fact}

\begin{construction}
  The product \(AÃ—B\) is given by \(\carr A Ã— \carr B\) with equality
  \[ \eq{\p{x,y}}{\p{x',y'}} â‰” \eq x {x'} âˆ§ \eq y {y'}\text. \]

  The projection \(Ï€ : AÃ—B â†¬ A\) is defined by
  \[ \p{\p{x,y}, x'} â†¦ \eq x {x'} âˆ§ \e y\text. \]
  The other projection is defined similarly
\end{construction}
\begin{proof}
  Symmetry and transitivity of the equality follow clearly.

  Likewise, the projection is clearly strict and well-defined.
  Uniqueness holds via
  \begin{align*}
    Ï€(\p{x,y},x') âˆ§ Ï€(\p{x,y},x'')
    &= \eq x {x'} âˆ§ \e y âˆ§ \eq x {x''} âˆ§ \e y\\
    &= \eq x {x'} âˆ§ \eq x {x''} âˆ§ \e y\\
    &â‰¤ \eq {x'} {x''} âˆ§ \e y\\
    &â‰¤ \eq {x'} {x''}\text.
  \end{align*}
  Totality holds via
  \begin{align*}
    \e{\p{x,y}} = \e x âˆ§ \e y = â‹_{x'âˆˆA}\eq x {x'} âˆ§ \e y\text.
  \end{align*}
\end{proof}

In the following, I will not write out these proofs. A standard reference is
TODO BorceuxV3.

\begin{construction}
  The \emph{discrete Heyting-valued set \(Î”A\) on \(A\)} has \(A\) as it's
  carrier and equality defined by \(\p{x,y} â†¦ â‹\set{âŠ¤}{x=y}\).
\end{construction}

\begin{fact}
  The empty type \(âˆ…\) is given by the empty carrier.

  The unit type \(\mb 1\) is given by \(\{\ast\}\) with \(\e\ast = âŠ¤\). This is
  the discrete Heyting-valued set on \(\{\ast\}\).

  The natural numbers object is the discrete Heyting-valued set on \(â„•\).

  The rational numbers object is the discrete Heyting-valued set on \(â„š\).
\end{fact}
\begin{note}
  The real numbers object is not necessarily discrete.
\end{note}

\begin{construction}
  The \emph{sum \(A+B\)} is given by \(\carr A+\carr B\) with equality
  \begin{align*}
    &\eq {\inl x} {\inl x'} â‰” \eq[A] x {x'}\\
    &\eq {\inl x} {\inr y'} â‰” âŠ¥\\
    &\eq {\inr y} {\inr x'} â‰” âŠ¥\\
    &\eq {\inr y} {\inr y'} â‰” \eq[B] y {y'}
  \end{align*}

  The inclusion \(Î¹ : A â†¬ A+B\) is given by \(\p{x,t} â†¦ \eq {\inl x} t\).
  The other inclusion is defined similarly.
\end{construction}

\begin{construction}
  The \emph{subobject classifier \(Î©\)} is given by \(\h\) with \(âˆ§\) as equality.
\end{construction}

\begin{construction}
  The \emph{exponential object \(B^A\)} is given by
  \[ \set{f : \carr A Ã— \carr B â†’ \h}{\ref{hvm:str}-\ref{hvm:unique}} \]
  with equality
  \[ \p{f,g} â†¦ â‹€_{xâˆˆA}â‹_{yâˆˆB}f(x,y) âˆ§ g(x,y)\text. \]
\end{construction}
\begin{internal}
  The equality in the internal language is
  \(\for{xâˆˆA}{\exist{yâˆˆB}{f(x, y) âˆ§ g(x, y)}}\) which can be rephrased as
  \(\for{xâˆˆA}{f(a) = g(a)}\). Thus equality models function extensionality,
  which is know to hold in Grothendieck toposes.
\end{internal}

\begin{fact}
  The \emph{power-object \(ğ’«A = Î©^A\)} can be given as the discrete Heyting-valued set
  on \(\set{P : \carr A â†’ Î©}{\eq {x'} x âˆ§ P(x) â‰¤ P(x')}\).
\end{fact}

\begin{construction}
  The \emph{restriction \(A\res p\)} is given by \(\set{x âˆˆ A}{\e x \between p}\)
\end{construction}

\begin{construction}
  Given a Heyting-valued set \(A\) and a relation \(R : \carr A Ã— \carr A â†’ \h\)
  satisfying
  \begin{gather}
    \e x â‰¤ R x x\\
    R x y â‰¤ R y x\\
    R x y âˆ§ R y z â‰¤ R x z
  \end{gather}
  we can form the \emph{quotient \(\quot A R\)} with carrier
  \(\carr A\) and equality \(R\).
\end{construction}
Subquotients can be formed similarly, by merely dropping the first condition on
the relation.

\subsection{CwF structure}

To define what is a family we first define a ``universe''.

\begin{construction}
  Up to size issues, the class of all Heyting-valued sets \(\hvsets\) with
  equality \(\p{A,B} â†¦ â‹\set{pâˆˆ\h}{A\res p = B\res p}\) is a Heyting-valued set.

  We will call it the \emph{Universe \(ğ’°\)}.
\end{construction}

\begin{construction}
  Given a  family \(\p{Bâ‚}_{aâˆˆA}\) of Heyting-valued sets, such that
  \(Bâ‚\res{\eq a {a'}} = B_{a'}\res{\eq a {a'}}\), the \emph{gluing \(â‹B\)} has carrier
  \[ \set{b âˆˆ Bâ‚\res{\e a}}{a âˆˆ A} = â‹ƒ_{a âˆˆ A}Bâ‚\res{\e a} \] and equality
  %\[ \p{b, b'} â†¦ â‹_{a,a' âˆˆ A} b âˆˆ Bâ‚\res {\eq a {a'}} âˆ§ b' âˆˆ B_{a'}\res{\eq a {a'}}
  %  âˆ§ \eq a {a'} âˆ§ \eq[Bâ‚\res {\eq a {a'}}] b {b'}\text. \]
  %\[ \p{b, b'} â†¦ â‹_{a âˆˆ A} b,b' âˆˆ Bâ‚\res {\e a} âˆ§ \eq[Bâ‚\res {\e a}] b {b'}\text. \]
  \[ \p{b, b'} â†¦ â‹\set{\eq[Bâ‚\res {\e a}] b {b'}}{a âˆˆ A b,b' âˆˆ Bâ‚\res {\e a}} \text. \]
\end{construction}
\begin{internal}
  Elements of the gluing should obviously come from the elements of individual
  sets \(Bâ‚\), ``modulo equality''. Since we are working with Heyting-valued
  sets we know we can move the quotient from the carrier set to the
  equality relation, as we do here.

  Internally, the equality relation would look something like
  \[ \exist{a âˆˆ A}{b,b' âˆˆ Bâ‚ âˆ§ \eq[Bâ‚] b {b'}} \]
  and this should be our working intuition for the equality.

  Of note is that we omit elements of \(Bâ‚\) that don't exist anywhere on
  \(\e a\). This does not really matter, as those elements would not exist in
  the gluing, but this gives a simpler presentation and might be useful later.
\end{internal}
\begin{proof}
  Let \(bâ‚€, bâ‚, bâ‚‚ âˆˆ â‹B\). Then by construction \(báµ¢ âˆˆ B_{aáµ¢}\res{\e {aáµ¢}}\) for
  some \(aáµ¢ âˆˆ A\).
  \begin{align*}
    \eq {bâ‚€} {bâ‚}
    &= â‹_{a âˆˆ A} bâ‚€,bâ‚ âˆˆ Bâ‚\res {\e a} âˆ§ \e a âˆ§ \eq[Bâ‚\res {\e a}] {bâ‚€} {bâ‚}\\
    &â‰¤ â‹_{a âˆˆ A} bâ‚,bâ‚€ âˆˆ Bâ‚\res {\e a} âˆ§ \e a âˆ§ \eq[Bâ‚\res {\e a}] {bâ‚} {bâ‚€}\\
    &= \eq {bâ‚} {bâ‚€}
  \end{align*}
  \begin{align*}
    \eq {bâ‚€} {bâ‚} âˆ§ \eq {bâ‚} {bâ‚‚}
    &= â‹_{a,a' âˆˆ A} bâ‚€,bâ‚ âˆˆ Bâ‚\res {\e a} âˆ§ \e a âˆ§ \eq[Bâ‚\res {\e a}] {bâ‚€} {bâ‚}
    âˆ§ bâ‚,bâ‚‚ âˆˆ B_{a'}\res {\e {a'}} âˆ§ \e {a'} âˆ§ \eq[B_{a'}\res {\e {a'}}] {bâ‚} {bâ‚‚}\\
    &= â‹_{a âˆˆ A} bâ‚€,bâ‚,bâ‚‚ âˆˆ Bâ‚\res {\e a} âˆ§ \e a
    âˆ§ \eq[Bâ‚\res {\e a}] {bâ‚€} {bâ‚} âˆ§ \eq[Bâ‚\res {\e a}] {bâ‚} {bâ‚‚}\\
    &â‰¤ â‹_{a âˆˆ A} bâ‚€,bâ‚‚ âˆˆ Bâ‚\res {\e a} âˆ§ \e a
    âˆ§ \eq[Bâ‚\res {\e a}] {bâ‚€} {bâ‚‚}\\
    &= \eq {bâ‚€} {bâ‚‚}\qedhere
  \end{align*}
\end{proof}

\begin{definition}
  A \emph{family \(B\) over \(A\)} is a map \(B : A â†’ ğ’°\)
  satisfying \(Ï†(x)\res{\eq x {x'}} = Ï†(x')\res{\eq x {x'}}\) and
  \(Ï†(x) = Ï†(x)\res{\e x}\).

  We denote the collection of families over \(A\) by \(\fam A\). The first
  property is called \emph{coherence} and the second is called \emph{canonicity}.
\end{definition}

\begin{construction}
  The isomorphism between morphisms \(A â†¬ ğ’°\) and families over \(A\) is given
  by
  \mordef{\p{-}^\flat}{\p{A â†¬ ğ’°}}{\fam A}
  {B}{\p{a â†¦ â‹\p{X\res{B(a,X)}}_{\mkern-6muX âˆˆ ğ’°}}}
  and
  \mordef{\tilde{\p{-}}}{\fam A}{\p{A â†¬ ğ’°}}
  {B}{\p{\p{a, X} â†¦ \e a âˆ§ \eq[ğ’°] {B(a)} X}\text.}
\end{construction}
\begin{proof}
  The relation \(\tilde B\) is obviously a morphism \(A â†¬ ğ’°\) for \(B âˆˆ \fam A\).

  For the other direction fix \(a âˆˆ A\) and \(B : A â†¬ ğ’°\).

  Because \(B\) is a morphism we have
  \(B(a,X\res{B(a,X)}) = B(a,Y\res{B(a,Y)})\) iff
  \({X\res{B(a,X)}} = {Y\res{B(a,Y)}}\).

  This means we can rewrite the gluing as being over the set
  \(\set{B(a, X)}{X âˆˆ ğ’°}\). This means that the carrier is a small union of
  small sets, and is thus small. Therefore it's a Heyting-valued set and thus an
  element of \(ğ’°\), so this indeed defines a map \(A â†’ ğ’°\).

  Take now another \(a'\) to show the family coherence property.
  The restriction \(B^\flat(a)\res{\eq a {a'}}\) has as carrier
  \[ \set{x âˆˆ X}{X âˆˆ ğ’° âˆ§ \p{\e x âˆ§ B(a, X)} \between \eq a {a'}}\text. \]
  The intersecting condition is equivalent to
  \[ âŠ¥ < \e x âˆ§ f(a,X) âˆ§ \eq a {a'}\text, \]
  which is obviously equivalent to
  \(\p{\e x âˆ§ f(a', X)} \between \eq a {a'}\).
  Thus we have \({B^\flat(a)\res{\eq a {a'}} = B^\flat(a')\res{\eq a {a'}}}\)
  and \(B^\flat\) is a family over \(A\).

  It remains to show the maps are inverses.
  First let \(a âˆˆ A\) and \(B : \fam A\).
  \begin{align*}
    {\tilde{B}}^\flat(a)
    &= â‹\p{X\res{\tilde B(a,X)}}\\
    &= â‹\p{X\res{\e a âˆ§ \eq {B(a)} X}}\\
    &= â‹\p{\p{X\res{\eq {B(a)} X}}\res{\e a}}\\
    &= â‹\p{\p{B(a)\res{\eq {B(a)} X}}\res{\e a}}\\
    &= B(a)\res{\e a}\\
    &= B(a)
  \end{align*}

  Now let \(a âˆˆ A\), \(X âˆˆ ğ’°\), and \(B : A â†¬ ğ’´\).
  \begin{align*}
    \tilde{B^\flat}(a, X)
    &= \e a âˆ§ \eq {B^\flat(a)} X\\
    &= \e a âˆ§ â‹_{Y âˆˆ ğ’°}\eq {Y\res{B(a,Y)}} X\\
    &= \e a âˆ§ â‹_{Y âˆˆ ğ’°}\eq Y X âˆ§ B(a, X)\\
    &= B(a, X)\qedhere
  \end{align*}
\end{proof}
% \begin{proof}
%   Take \(a âˆˆ A\). The type \(Ï†(a)\) is the gluing of the family
%   \(\p{X\res{f(a,X)}}_{\mkern-6muX âˆˆ ğ’°}\), that is the set
%   \(\set{x âˆˆ X}{X âˆˆ ğ’° âˆ§ \e x \between f(a, X)}\) with equality
%   \[ \p{x,y} â†¦ â‹_{Xâˆ‹x,\\Yâˆ‹y}f(a, X) âˆ§ f(a, Y) âˆ§ \eq[X\res{\eq X Y}] x y\text. \]

%   This gluing is small since the collection \(I â‰” \{X\res{f(a,X)} âˆˆ \hvsets\}\) is a
%   set.
%   If \(f(a,X\res{f(a,X)}) = f(a,Y\res{f(a,Y)})\) then
%   \(\eq[ğ’°] {X\res{f(a,X)}} {Y\res{f(a,Y)}}\).
%   Therefore the collection \(I\) has at most \(\h\) many elements.

%   Take another \(a' âˆˆ A\). The restriction \(Ï†(a)\res{\eq a {a'}}\) has as
%   carrier
%   \[ \set{x âˆˆ X}{X âˆˆ ğ’° âˆ§ \e x âˆ§ f(a,x) \between \eq a {a'}}\text. \]
%   The condition \(\e x âˆ§ f(a, X) \between \eq a {a'}\) is equivalent to
%   \[ âŠ¥ < \e x âˆ§ f(a, X) âˆ§ \eq a {a'} \text, \]
%   so it is also equivalent to \(\e x âˆ§ f(a', X) \between \eq a {a'}\).

%   Thus, \(Ï†(a)\res{\eq a {a'}} = Ï†(a')\res{\eq a {a'}}\).

%   In the other direction taking a map \(Ï† : A â†’ ğ’°\) we define
%   \(f(a, X) â‰” \e a âˆ§ \eq X {Ï†(a)}\). This is obviously a morphism
%   \(f : A â†¬ ğ’°\).

%   If \(f = g : A â†¬ ğ’°\), then for \(a âˆˆ A\) we have
%   \[ Ï†(a) = â‹\p{X\res{f(a, X)}} = â‹\p{X\res{g(a, X)}} = Î³(a)\text. \]

%   Let \(a âˆˆ A\), \(Ï† : A â†’ ğ’°\), and \(f\) the corresponding morphism. Let \(Î³\)
%   denote the corresponding map to \(f\).
%   \begin{align*}
%     Î³(a)
%     &â‰” â‹\p{X\res{f(a, X)}}\\
%     &= â‹\p{X\res{\e a âˆ§ \eq X {Ï†(a)}}}\\
%     &= â‹\p{X\res{\eq X {Ï†(a)}}}\res{\e a}\\
%     &= â‹\p{Ï†(a)}\res{\e a}\\
%     &= Ï†(a)
%   \end{align*}

%   Let now \(f : A â†¬ ğ’°\), \(Ï†\) the corresponding map to \(f\), and \(g\) be the
%   corresponding morphism to \(Î³\). It remains to show that \(g = f\). For
%   \(a âˆˆ A\) and \(X âˆˆ ğ’°\) we have
%   \begin{align*}
%     g(a, X)
%     &= \e a âˆ§ \eq X {Ï†(a)}\\
%     &= \e a âˆ§ â‹_{Y âˆˆ ğ’°} \eq X {Y\res{f(a, Y)}}\\
%     &= \e a âˆ§ â‹_{Y âˆˆ ğ’°} \eq X Y âˆ§ f(a, Y)\\
%     &= \e a âˆ§ f(a, X)\\
%     &= f(a, X)
%   \end{align*}
% \end{proof}


\begin{construction}
  Up to size issues the category of Heyting-valued sets is a category with
  families.

  Let \(Î“\) and \(Î”\) be Heyting-valued sets, \(A\) a family over \(Î“\), and
  \(Î³ : Î” â†¬ Î“\).
  \begin{itemize}
  \item \(\ctx â‰” \hvsets\)
  \item \(\ty Î“ â‰” \fam Î“\)
  \item \(\ty Î³ â‰” Î³^*\)
  \item \(\tm Î“ A â‰” \set{\p{\sigma{g âˆˆ \carr Î“}{\carr {A(g)}}} â†’ \h}{\ref{hvm:str}-\ref{hvm:total}}\)
  \item \(\tm Î³ A â‰” f â†¦ \p{\p{d, a} â†¦ f(Î³(d), a)}\)
  \item \(\ext Î“ A â‰” \p{\sigma{g âˆˆ \carr Î“}{\carr{A(g)}},
      \p{\p{g, a},\p{g',a'}} â†¦ \eq[Î“] g {g'} âˆ§ \eq[A(g)] a {a'}}\)
    NOTE: gluing?
  \item \(\ext Î³ t â‰” \p{d,\p{g,a}} â†¦ Î³(d, g) âˆ§ t(d, a)\)
  \end{itemize}
  Call this category with families \(\hvcwf\)
\end{construction}

\begin{construction}
  \(\hvcwf\) has extensional dependent sums. Let \(Î“ : \ctx\), \(A : \ty Î“\), and
  \(B : \ty \ext Î“ A\).
  \begin{itemize}
  \item \(Î£ Î‘ Î’ (g) â‰” \p{\sigma{a âˆˆ \carr{A(g)}}{\carr{B(g, a)}},
      \p{\p{a,b},\p{a',b'}} â†¦ \eq[A(g)] a {a'} âˆ§ \eq[B(g,a)] b {b'}}\)
  \item \(\pair(\p{g, a}, b) â‰” \p{g, \p{a,b}} : \ext {\ext Î“ A} B â‰… \ext Î“ {Î£ Î‘ Î’}\)
  \end{itemize}
\end{construction}

\begin{construction}
  \(\hvcwf\) has dependent products. Let \(Î“ : \ctx\), \(A : \ty Î“\), and
  \(B : \ty \ext Î“ A\).
  \begin{itemize}
  \item \(Î  Î‘ Î’ (g) â‰”
    \p{\set{f : \sigma{a âˆˆ \carr{A(g)}}{\carr{B(g, a)}} â†’ \h}{\ref{hvm:str}-\ref{hvm:unique}},
      \p{f, f'} â†¦ â‹€_{a âˆˆ A(g)}â‹_{b âˆˆ B(g,a)}f(a,b)âˆ§f'(a,b)}\)
  \item \(\tm Î“ {\p{Î  A B}} = \tm {\p{\ext Î“ A}} B\)
  \end{itemize}
\end{construction}


\begin{construction}
  \(\hvcwf\) has unit types \(- â†¦ \mb 1 âˆˆ \fam Î“\).
\end{construction}

\begin{construction}
  \(\hvcwf\) has natural number types \(- â†¦ â„• âˆˆ \fam Î“\).
\end{construction}

\begin{construction}
  \(\hvcwf\) has extensional identity types.
  \[
    \idty[A] a {a'} (g) â‰” \mb 1 \res{\eq[A(g)] a {a'}}
  \]
\end{construction}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../main"
%%% End:
